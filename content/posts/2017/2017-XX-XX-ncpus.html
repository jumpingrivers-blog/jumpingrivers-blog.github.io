---
title: "Speeding up package installation"
author: "Colin Gillespie"
date: 2017-10-16
output: html_document
#image: "img/2017/tibbles.png"
draft: true
slug: "speed_package_installation"
tags: [rstats,tidyverse,packages]
---


<div id="TOC">
<ul>
<li><a href="#the-ncpus-options">The Ncpus options</a></li>
<li><a href="#does-it-work">Does it work?</a></li>
</ul>
</div>

<p>One of the best features of R is CRAN and the associated package manager. When a package is submitted to CRAN, not only is it checked under three versions of R</p>
<ul>
<li>R-past, R-release and R-devel</li>
</ul>
<p>and three versions of operating system</p>
<ul>
<li>Windows, Linux and Mac (with multiple flavours of each)</li>
</ul>
<p>CRAN also checks that the updated package doesn’t break existing packages. This last part is particularly tricky when you consider all the dependencies a package like <strong>ggplot2</strong> or <strong>Rcpp</strong> has. Furthermore, it performs all these checks within 24 hours, ready for the next set packages.</p>
<p>What many people don’t realise is that for CRAN to perform this miracle of package checking, it builds and checks these packages in <strong>parallel</strong>; so rather than installing a single package at a time, we can install multiple packages at once. Now, we can’t just install packages at random due to the connectiveness between packages, but R takes care of these details.</p>
<div id="the-ncpus-options" class="section level3">
<h3>The Ncpus options</h3>
<p>If you examine the help package of <code>?install.packages</code>, there’s a sneaky argument called <code>Ncpus</code>, that is often overlooked. From the help page:</p>
<blockquote>
<p>Ncpus: The number of parallel processes to use for a parallel install of more than one source package.</p>
</blockquote>
<p>The default value of this argument is</p>
<blockquote>
<p>Ncpus = getOption(“Ncpus”, 1L)</p>
</blockquote>
<p>The <code>getOption()</code> part determines if the value has been set in <code>options()</code>. If no value is found, the default number of processes to use is <code>1</code>. If you haven’t heard of <code>Ncpus</code>, it’s almost certainly 1.</p>
</div>
<div id="does-it-work" class="section level3">
<h3>Does it work?</h3>
<p>To test if changing the value of <code>Ncpus</code> makes a difference, we install the <strong>tidyverse</strong> package with all it’s associated dependencies. On my machine, all packages live in a directory called <code>/rpackages/</code>, for each test below I deleted <code>/rpackages/</code> so all <strong>tidyverse</strong> dependencies were reinstalled.</p>
<p>My machine has eight cores</p>
<pre class="r"><code>parallel::detectCores()
# [1] 8</code></pre>
<p>So it doesn’t make sense to set <code>Ncpus</code> above 8.</p>
<p>For this experiment, I used the RStudio CRAN repository, set via</p>
<pre class="r"><code>options(repos = c(&quot;CRAN&quot; = &quot;https://cran.rstudio.com/&quot;))</code></pre>
<p>To time the installation procedure, I just use the standard <code>system.time()</code> function.</p>
<p>After removing the <code>/rpackages</code> directory, I set <code>Ncpus</code> equal to <code>1</code> and installed <code>tidyverse</code></p>
<pre class="r"><code>options(Ncpus = 1)
system.time(install.packages(&quot;tidyverse&quot;))
## Time in seconds
#    user  system elapsed 
#372.252  15.468 409.364 </code></pre>
<p>So a standard installation takes almost 7 minutes (409/60)! A couple of caveats:</p>
<ul>
<li>This timing also includes the download time of the packages; however for simplicity I’m ignoring this. Downloading the packages takes around 20 seconds</li>
<li>The above number is uses a sample size of 1 to estimate the time; repeating the above experiment, resulted in a remarkably consistent installation time of 410 seconds.</li>
</ul>
<p>Repeating this experiment with different values of <code>Ncpus</code> gives the table below:</p>
<table>
<thead>
<tr class="header">
<th>Ncpus</th>
<th>elapsed</th>
<th>Ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>409</td>
<td>2.26</td>
</tr>
<tr class="even">
<td>2</td>
<td>224</td>
<td>1.24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>196</td>
<td>1.08</td>
</tr>
<tr class="even">
<td>8</td>
<td>181</td>
<td>1.00</td>
</tr>
</tbody>
</table>
<div id="references" class="section level4">
<h4>References</h4>
<p>If you are interested in how CRAN handles the phenomena number of package submissions, check out this recent talk:</p>
<ul>
<li><a href="https://channel9.msdn.com/Events/useR-international-R-User-conferences/useR-International-R-User-2017-Conference/KEYNOTE-20-years-of-CRAN">Twenty years of CRAN</a> by Uwe Ligges at UseR2017! in Brussels.</li>
</ul>
</div>
</div>
